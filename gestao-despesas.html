<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gest√£o de Despesas | Relevo Consultoria Ambiental</title>

  <link rel="icon" href="/assets/icons/favicon.ico">
  <link rel="icon" sizes="32x32" href="/assets/icons/favicon-32.png">
  <link rel="icon" sizes="16x16" href="/assets/icons/favicon-16.png">
  <link rel="icon" sizes="192x192" href="/assets/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/assets/icons/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#0b2e1b">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/styles/global.css"/>
  <link rel="stylesheet" href="/styles/relevo-theme.css"/>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  <script src="/scripts/firebase-init-guard.js"></script>
  <script src="/scripts/firebase-despesas-reader.js"></script>

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    .dashboard-wrapper{display:grid;grid-template-columns:330px 1fr;min-height:100vh}
    .sidebar{background:var(--relevo-surface-solid);border-right:1px solid var(--relevo-border);padding:18px;display:flex;flex-direction:column;gap:14px;overflow-y:auto;z-index:1000}
    .brand{display:flex;justify-content:center;padding:8px 0}
    .brand img{width:120px;height:auto;display:block}
    .sidebar-section h3{font-size:11px;text-transform:uppercase;letter-spacing:1.2px;color:var(--relevo-muted);margin:12px 0 8px;padding-bottom:6px;border-bottom:1px solid var(--relevo-border)}
    .filter-group{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .filter-group label{font-weight:800;font-family:var(--relevo-font-title);color:var(--relevo-text);font-size:13px}
    .filter-group select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--relevo-border);background:rgba(255,255,255,.85);color:var(--relevo-text);font-family:Montserrat,sans-serif;outline:none}
    .sidebar-actions{display:flex;gap:10px;flex-wrap:wrap}
    .sidebar-actions .btn{flex:1;min-width:120px;justify-content:center;display:flex;align-items:center;gap:8px;padding:10px 12px}
    .mini-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
    .mini-item{border:1px solid var(--relevo-border);background:rgba(255,255,255,.85);border-radius:14px;padding:10px 12px;cursor:pointer;transition:.15s}
    .mini-item:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .mini-item .top{display:flex;justify-content:space-between;gap:10px}
    .mini-item .proj{font-weight:800;color:var(--relevo-text);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:210px}
    .mini-item .valor{font-weight:800;color:var(--relevo-text);font-size:12px;white-space:nowrap}
    .mini-item .meta{margin-top:4px;font-size:11px;color:var(--relevo-muted);display:flex;justify-content:space-between;gap:10px}

    .main-content{padding:26px 26px 40px;background:var(--relevo-gradient-soft);min-width:0}

    .kpis-sticky{position:sticky;top:0;z-index:50;padding-top:8px;padding-bottom:12px;backdrop-filter:blur(10px)}
    .kpis-sticky::before{content:"";position:absolute;inset:0;background:rgba(234,244,238,.75);border:1px solid rgba(0,0,0,.04);border-radius:18px;z-index:-1}
    .kpis-row{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:14px}
    .kpi-card{background:rgba(255,255,255,.85);border:1px solid var(--relevo-border);border-radius:16px;padding:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
    .kpi-card h3{margin:0 0 8px;font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--relevo-muted);font-weight:900;font-family:var(--relevo-font-title)}
    .kpi-card .value{font-size:22px;font-weight:900;color:var(--relevo-text);font-family:var(--relevo-font-title)}

    .view{margin-top:16px}
    .hidden{display:none!important}

    .dashboard-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    .dash-card{background:rgba(255,255,255,.85);border:1px solid var(--relevo-border);border-radius:16px;padding:14px;box-shadow:0 10px 22px rgba(0,0,0,.06);min-height:380px;display:flex;flex-direction:column;gap:10px}
    .dash-card h3{margin:0;font-size:14px;font-weight:900;color:var(--relevo-text);font-family:var(--relevo-font-title);display:flex;align-items:center;gap:10px}
    .badge-dot{width:10px;height:10px;border-radius:999px;background:var(--relevo-green-600);display:inline-block;flex-shrink:0}
    .chart-container{position:relative;width:100%;height:320px}
    .chart-container canvas{width:100%!important;height:100%!important;display:block}

    .table-section{background:#fff;border-radius:16px;border:1px solid rgba(0,0,0,.08);box-shadow:0 10px 24px rgba(0,0,0,.08);overflow:hidden}
    .table-header{background:var(--relevo-green-700);color:#fff;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .table-header h3{margin:0;font-size:14px;font-weight:900}
    .table-container{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;font-size:13px}
    th{position:sticky;top:0;background:#0a4723;color:#fff;z-index:1}
    tbody tr:hover{background:#f7f7f7}

    .actions-cell button{border:1px solid #e5e5e5;background:#fff;color:#111;border-radius:10px;padding:8px 10px;cursor:pointer;margin-right:6px}
    .actions-cell button:hover{background:#f3f3f3}

    .comprovante-miniatura{width:46px;height:46px;object-fit:cover;cursor:pointer;border-radius:8px;border:1px solid rgba(0,0,0,.08);transition:transform .15s;background:#fafafa}
    .comprovante-miniatura:hover{transform:scale(1.06)}

    .modal{display:none;position:fixed;z-index:2000;inset:0;padding-top:60px;background:rgba(0,0,0,.9)}
    .modal-content{margin:auto;display:block;width:80%;max-width:900px;max-height:85vh;object-fit:contain;border-radius:12px}
    .close{position:absolute;top:14px;right:18px;color:#fff;font-size:42px;font-weight:900;cursor:pointer;user-select:none}

    /* Mobile */
    .mobile-top-bar{display:none;background:var(--relevo-green-900);color:#fff;padding:12px 16px;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1100}
    .mobile-top-bar .left{display:flex;gap:10px;align-items:center;min-width:0}
    .mobile-top-bar .left img{height:26px;width:auto;display:block}
    .mobile-top-bar .title{font-family:var(--relevo-font-title);font-weight:800;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .icon-btn{background:transparent;border:0;color:inherit;cursor:pointer;padding:8px;border-radius:10px;display:flex;align-items:center;justify-content:center}
    .icon-btn:hover{background:rgba(255,255,255,.12)}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999}

    @media (max-width:1050px){.dashboard-grid{grid-template-columns:1fr}}
    @media (max-width:900px){
      .dashboard-wrapper{grid-template-columns:1fr}
      .mobile-top-bar{display:flex}
      .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);width:330px;max-width:90vw;transition:transform .28s ease;box-shadow:12px 0 28px rgba(0,0,0,.12)}
      .sidebar.active{transform:translateX(0)}
      .sidebar-overlay.active{display:block}
      .main-content{padding:18px 16px 40px}
      .kpis-row{grid-template-columns:1fr}
    }
  </style>
</head>

<body class="relevo-theme">

  <header class="mobile-top-bar">
    <div class="left">
      <img src="/assets/icons/icon-192.png" alt="Relevo">
      <div class="title">Gest√£o de Despesas</div>
    </div>
    <button id="menuTrigger" class="icon-btn" type="button" aria-label="Abrir menu">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="white" stroke-width="2.2" stroke-linecap="round"/></svg>
    </button>
  </header>

  <div class="sidebar-overlay" id="overlay"></div>

  <div class="dashboard-wrapper">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <img src="/styles/icons/Logo_atualizada_vertical.png" alt="Relevo">
      </div>

      <section class="sidebar-section">
        <h3>Filtros</h3>

        <div class="filter-group">
          <label for="filterProjeto">Projeto</label>
          <select id="filterProjeto"><option value="">Todos</option></select>
        </div>

        <div class="filter-group">
          <label for="filterFuncionario">Funcion√°rio</label>
          <select id="filterFuncionario"><option value="">Todos</option></select>
        </div>

        <div class="filter-group">
          <label for="filterTipo">Gasto</label>
          <select id="filterTipo"><option value="">Todos</option></select>
        </div>

        <div class="sidebar-actions">
          <button class="btn btn-secondary" id="btnLimpar" type="button">Limpar</button>
          <button class="btn btn-primary" id="btnAplicar" type="button">Aplicar</button>
        </div>
      </section>

      <section class="sidebar-section" style="margin-top:6px;">
        <h3>Lista de despesas</h3>

        <div class="sidebar-actions" style="margin-bottom:10px;">
          <button class="btn btn-primary" id="btnVerGraficos" type="button" style="flex:1;">Gr√°ficos</button>
          <button class="btn btn-secondary" id="btnVerLista" type="button" style="flex:1;">Lista</button>
        </div>
</section>

      <div style="margin-top:auto; padding-top:8px; display:flex; flex-direction:column; gap:10px;">
        <a class="btn btn-primary" href="/despesas" target="_blank" rel="noopener" style="justify-content:center;">Lan√ßar despesa</a>
        <a class="btn btn-secondary" href="/gestao.html" style="justify-content:center;">Voltar √† Gest√£o</a>
      </div>
    </aside>

    <main class="main-content">
      <h1 style="margin:0 0 6px;">Gest√£o de Despesas</h1>
      <p class="muted" style="margin:0 0 10px;">Filtros na lateral, KPIs fixos no topo e troca r√°pida entre gr√°ficos e lista.</p>

      <section class="kpis-sticky" aria-label="KPIs">
        <div class="kpis-row">
          <div class="kpi-card"><h3>Total gasto</h3><div class="value" id="kpiTotalGasto">R$ 0,00</div></div>
          <div class="kpi-card"><h3>Despesas do m√™s</h3><div class="value" id="kpiDespesasMes">0</div></div>
          <div class="kpi-card"><h3>Total aprovado</h3><div class="value" id="kpiTotalAprovado">R$ 0,00</div></div>
        </div>
      </section>

      <section class="view" id="viewGraficos">
        <div class="dashboard-grid">
          <div class="dash-card"><h3><span class="badge-dot"></span> Evolu√ß√£o Mensal</h3><div class="chart-container"><canvas id="chartEvolucao"></canvas></div></div>
          <div class="dash-card"><h3><span class="badge-dot" style="background:#eb8807;"></span> Distribui√ß√£o por tipo</h3><div class="chart-container"><canvas id="chartTipos"></canvas></div></div>
          <div class="dash-card"><h3><span class="badge-dot" style="background:#1565c0;"></span> Top projetos</h3><div class="chart-container"><canvas id="chartProjetos"></canvas></div></div>
          <div class="dash-card"><h3><span class="badge-dot" style="background:#4e296b;"></span> Gastos por pessoa</h3><div class="chart-container"><canvas id="chartFuncionarios"></canvas></div></div>
        </div>
      </section>

      <section class="view hidden" id="viewLista">
        <div class="table-section">
          <div class="table-header">
            <h3>Lista de Despesas</h3>
            <button class="btn btn-primary" type="button" id="exportBtn">Exportar CSV</button>
          </div>
          <div class="table-container">
            <table id="tabelaDespesas">
              <thead>
                <tr>
                  <th>Data</th><th>Projeto</th><th>Funcion√°rio</th><th>Tipo</th><th>Descri√ß√£o</th><th>Valor</th><th>Status</th><th>Comprovante</th><th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbodyDespesas"><tr><td colspan="9" style="text-align:center;padding:18px;color:#555;">Carregando despesas...</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <div id="comprovanteModal" class="modal">
        <span class="close" id="closeModal">&times;</span>
        <img class="modal-content" id="imgComprovante" alt="Comprovante">
      </div>
    </main>
  </div>

  <script>
    // Menu mobile (padr√£o portal: defensivo)
    (function(){
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      const trigger = document.getElementById('menuTrigger');
      function openMenu(){ sidebar && sidebar.classList.add('active'); overlay && overlay.classList.add('active'); }
      function closeMenu(){ sidebar && sidebar.classList.remove('active'); overlay && overlay.classList.remove('active'); }
      trigger && trigger.addEventListener('click', openMenu);
      overlay && overlay.addEventListener('click', closeMenu);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });
    })();

    // Chart.js defaults
    Chart.register(ChartDataLabels);
    Chart.defaults.color = '#000';
    Chart.defaults.font.family = 'Montserrat';
    Chart.defaults.plugins.datalabels = { color:'#000', font:{weight:'600'}, anchor:'end', align:'top',
      formatter:(v)=> (typeof v==='number' ? ('R$ '+v.toLocaleString('pt-BR')) : '') };

    let despesas = [];
    let filteredDespesas = [];
    const charts = {};

    const $ = (id)=>document.getElementById(id);

    document.addEventListener('DOMContentLoaded', async ()=>{
      bindUI();
      await carregarDespesas();
      inicializarFiltros();
      setView('graficos');
    });

    function bindUI(){
      $('btnAplicar')?.addEventListener('click', aplicarFiltros);
      $('btnLimpar')?.addEventListener('click', limparFiltros);
      $('btnVerGraficos')?.addEventListener('click', ()=>setView('graficos'));
      $('btnVerLista')?.addEventListener('click', ()=>setView('lista'));
      $('exportBtn')?.addEventListener('click', exportarCSV);
      $('closeModal')?.addEventListener('click', fecharModalComprovante);
      window.addEventListener('click', (e)=>{ const m=$('comprovanteModal'); if(m && e.target===m) fecharModalComprovante(); });
    }

    function setView(mode){
      const vg=$('viewGraficos'); const vl=$('viewLista');
      if(!vg||!vl) return;
      const isLista = mode==='lista';
      vg.classList.toggle('hidden', isLista);
      vl.classList.toggle('hidden', !isLista);
    }

    function getPalette(n){
      const base=['#26C04C','#2E7D32','#EB8807','#6B5539','#4E296B','#1B5E20','#00796B','#1565C0','#8E24AA','#F4511E'];
      return Array.from({length:n},(_,i)=>base[i%base.length]);
    }

    async function carregarDespesas(){
      const snap = await dbDespesas.collection('despesas').orderBy('createdAt','desc').get();
      const raw = snap.docs.map(doc=>({ id:doc.id, ...doc.data(), data:doc.data().data||'', valor:Number(doc.data().valor||0) }));
      despesas = await Promise.all(raw.map(async d=>{ if(d.comprovantePath) d.comprovanteUrl = await getComprovanteUrl(d.comprovantePath); return d; }));
      atualizarTudo();
    }

    async function getComprovanteUrl(path){
      try{ return await storageDespesas.ref(path).getDownloadURL(); }
      catch(err){ console.error('Erro ao obter URL do comprovante:', path, err); return null; }
    }

    function getDadosAtivos(){ return (filteredDespesas && filteredDespesas.length) ? filteredDespesas : despesas; }

    function atualizarTudo(){ atualizarKPIs(); atualizarTabela(); atualizarGraficos(); }

    function atualizarKPIs(){
      const dados=getDadosAtivos();
      const total=dados.reduce((s,d)=>s+(Number(d.valor)||0),0);
      const agora=new Date(); const mes=agora.getMonth(); const ano=agora.getFullYear();
      const despesasMes=dados.filter(d=>{ const dt=d.data?new Date(d.data):null; return dt && !isNaN(dt) && dt.getMonth()===mes && dt.getFullYear()===ano; }).length;
      const aprovadas=dados.filter(d=>{ const st=String(d.status||'').toLowerCase(); return st==='pago' || st==='aprovado'; });
      const totalAprovado=aprovadas.reduce((s,d)=>s+(Number(d.valor)||0),0);
      $('kpiTotalGasto').textContent=formatarMoeda(total);
      $('kpiDespesasMes').textContent=String(despesasMes);
      $('kpiTotalAprovado').textContent=formatarMoeda(totalAprovado);
    }

    function atualizarTabela(){
      const tbody=$('tbodyDespesas'); if(!tbody) return;
      const dados=getDadosAtivos();
      if(!dados.length){ tbody.innerHTML='<tr><td colspan="9" style="text-align:center;color:#666;padding:28px;">Nenhuma despesa encontrada</td></tr>'; return; }
      tbody.innerHTML=dados.map(d=>`
        <tr data-id="${escapeHtml(d.id)}">
          <td>${escapeHtml(formatarData(d.data))}</td>
          <td>${escapeHtml(d.projeto||'-')}</td>
          <td>${escapeHtml(d.funcionario||'-')}</td>
          <td>${escapeHtml(d.tipo||'-')}</td>
          <td>${escapeHtml((d.descricao||'').replace(/;/g, ','))}</td>
          <td><strong>${escapeHtml(formatarMoeda(d.valor))}</strong></td>
          <td>${escapeHtml(d.status||'pendente')}</td>
          <td>${d.comprovanteUrl ? `<img src="${d.comprovanteUrl}" alt="Comprovante" class="comprovante-miniatura" onclick="abrirModalComprovante('${d.comprovanteUrl}')">` : '-'}</td>
          <td class="actions-cell">
            <button title="Aprovar" onclick="aprovarDespesa('${d.id}')">‚úî</button>
            <button title="Editar" onclick="editarDespesa('${d.id}')">‚úé</button>
            <button title="Excluir" onclick="excluirDespesa('${d.id}')">üóë</button>
          </td>
        </tr>
      `).join('');
    }

    async function aprovarDespesa(id){ await dbDespesas.collection('despesas').doc(id).update({status:'pago'}); await carregarDespesas(); }
    async function excluirDespesa(id){ if(confirm('Deseja excluir esta despesa?')){ await dbDespesas.collection('despesas').doc(id).delete(); await carregarDespesas(); } }
    async function editarDespesa(id){
      const doc=await dbDespesas.collection('despesas').doc(id).get();
      if(!doc.exists) return alert('Despesa n√£o encontrada');
      const atual=Number(doc.data().valor||0);
      const entrada=prompt('Novo valor da despesa (ex: 123,45):', atual.toString().replace('.',','));
      if(entrada!==null){
        const num=parseFloat(String(entrada).replace('.','').replace(',','.'));
        if(!isNaN(num)){
          await dbDespesas.collection('despesas').doc(id).update({ valor:num, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
          await carregarDespesas();
        }
      }
    }

    function abrirModalComprovante(url){ const m=$('comprovanteModal'); const img=$('imgComprovante'); if(!m||!img) return; m.style.display='block'; img.src=url; }
    function fecharModalComprovante(){ const m=$('comprovanteModal'); if(m) m.style.display='none'; }

    function atualizarGraficos(){ graficoEvolucao(); graficoTipos(); graficoProjetos(); graficoFuncionarios(); }

    function graficoEvolucao(){
      const ctx=document.getElementById('chartEvolucao')?.getContext('2d'); if(!ctx) return;
      const dados=getDadosAtivos();
      const meses=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      const dataMensal=meses.map(()=>0);
      dados.forEach(d=>{ const dt=d.data?new Date(d.data):null; if(dt && !isNaN(dt)) dataMensal[dt.getMonth()]+= (Number(d.valor)||0); });
      charts.evolucao && charts.evolucao.destroy();
      charts.evolucao=new Chart(ctx,{ type:'line', data:{labels:meses,datasets:[{label:'Gastos Mensais (R$)',data:dataMensal,borderColor:'#2E7D32',backgroundColor:'rgba(38,192,76,0.18)',fill:true,tension:0.35,borderWidth:3,pointRadius:3}]},
        options:{plugins:{legend:{display:true},datalabels:{display:true}},responsive:true,maintainAspectRatio:false} });
    }

    function graficoTipos(){
      const ctx=document.getElementById('chartTipos')?.getContext('2d'); if(!ctx) return;
      const dados=getDadosAtivos(); const acc={};
      dados.forEach(d=>{ if(d.tipo) acc[d.tipo]=(acc[d.tipo]||0)+(Number(d.valor)||0); });
      const labels=Object.keys(acc); const data=Object.values(acc); const colors=getPalette(labels.length);
      charts.tipos && charts.tipos.destroy();
      charts.tipos=new Chart(ctx,{ type:'doughnut', data:{labels,datasets:[{label:'Valor por Tipo (R$)',data,backgroundColor:colors}]},
        options:{plugins:{legend:{position:'bottom'},datalabels:{display:true}},responsive:true,maintainAspectRatio:false} });
    }

    function graficoProjetos(){
      const ctx=document.getElementById('chartProjetos')?.getContext('2d'); if(!ctx) return;
      const dados=getDadosAtivos(); const acc={};
      dados.forEach(d=>{ if(d.projeto) acc[d.projeto]=(acc[d.projeto]||0)+(Number(d.valor)||0); });
      const top=Object.entries(acc).sort(([,a],[,b])=>b-a).slice(0,6);
      const labels=top.map(t=>t[0]); const data=top.map(t=>t[1]); const colors=getPalette(labels.length);
      charts.projetos && charts.projetos.destroy();
      charts.projetos=new Chart(ctx,{ type:'bar', data:{labels,datasets:[{label:'Valor (R$)',data,backgroundColor:colors,borderColor:'#000',borderWidth:1}]},
        options:{plugins:{legend:{display:false},datalabels:{display:true}},responsive:true,maintainAspectRatio:false,scales:{x:{ticks:{color:'#000'}},y:{ticks:{color:'#000'}}}} });
    }

    function graficoFuncionarios(){
      const ctx=document.getElementById('chartFuncionarios')?.getContext('2d'); if(!ctx) return;
      const dados=getDadosAtivos(); const acc={};
      dados.forEach(d=>{ if(d.funcionario) acc[d.funcionario]=(acc[d.funcionario]||0)+(Number(d.valor)||0); });
      const top=Object.entries(acc).sort(([,a],[,b])=>b-a).slice(0,8);
      const labels=top.map(t=>t[0]); const data=top.map(t=>t[1]); const colors=getPalette(labels.length);
      charts.funcionarios && charts.funcionarios.destroy();
      charts.funcionarios=new Chart(ctx,{ type:'polarArea', data:{labels,datasets:[{label:'Valor por Funcion√°rio (R$)',data,backgroundColor:colors}]},
        options:{plugins:{legend:{position:'bottom'},datalabels:{display:true}},responsive:true,maintainAspectRatio:false} });
    }

    function inicializarFiltros(){
      const projetos=[...new Set(despesas.map(d=>d.projeto).filter(Boolean))].sort();
      const funcs=[...new Set(despesas.map(d=>d.funcionario).filter(Boolean))].sort();
      const tipos=[...new Set(despesas.map(d=>d.tipo).filter(Boolean))].sort();
      preencherSelect('filterProjeto', projetos);
      preencherSelect('filterFuncionario', funcs);
      preencherSelect('filterTipo', tipos);
    }
    function preencherSelect(id, lista){
      const s=document.getElementById(id); if(!s) return;
      s.innerHTML='<option value="">Todos</option>';
      lista.forEach(v=> s.innerHTML += `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`);
    }

    function aplicarFiltros(){
      const p=document.getElementById('filterProjeto')?.value||'';
      const f=document.getElementById('filterFuncionario')?.value||'';
      const t=document.getElementById('filterTipo')?.value||'';
      filteredDespesas = despesas.filter(d => (!p || d.projeto===p) && (!f || d.funcionario===f) && (!t || d.tipo===t));
      atualizarTudo();
    }

    function limparFiltros(){
      document.getElementById('filterProjeto') && (document.getElementById('filterProjeto').value='');
      document.getElementById('filterFuncionario') && (document.getElementById('filterFuncionario').value='');
      document.getElementById('filterTipo') && (document.getElementById('filterTipo').value='');
      filteredDespesas=[];
      atualizarTudo();
    }

    function exportarCSV(){
      const dados=getDadosAtivos();
      if(!dados.length){ alert('Sem dados para exportar.'); return; }
      const projetoSelecionado=document.getElementById('filterProjeto')?.value||'';
      const titulo=projetoSelecionado ? `Projeto: ${projetoSelecionado}` : 'Projeto: Todos';
      const header=['DATA','PROJETO','FUNCION√ÅRIO','TIPO','DESCRI√á√ÉO','VALOR','STATUS','COMPROVANTE'];
      let csv=titulo+'\n'+header.join(';')+'\n';
      dados.forEach(d=>{
        const linha=[formatarData(d.data),(d.projeto||''),(d.funcionario||''),(d.tipo||''),(d.descricao||'').replace(/;/g, ','),String(Number(d.valor||0)).replace('.',','),(d.status||'pendente'),(d.comprovanteUrl||'')].join(';');
        csv += linha + '\n';
      });
      const blob=new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url;
      a.download=`despesas_relevo_${projetoSelecionado||'todos'}_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function formatarData(d){ if(!d) return '-'; const dt=new Date(d); return isNaN(dt)?'-':dt.toLocaleDateString('pt-BR'); }
    function formatarMoeda(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(v||0)); }
    function escapeHtml(str){
      return String(str ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }
  </script>
</body>
</html>

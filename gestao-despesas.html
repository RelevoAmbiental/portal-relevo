<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão de Despesas | Relevo Consultoria</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png"
        href="https://raw.githubusercontent.com/RelevoAmbiental/relevo-site/refs/heads/main/assets/icons/favicon_menos.png">

  <!-- CSS Global -->
  <link rel="stylesheet" href="styles/global.css">

  <!-- Ícones -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="scripts/firebase-init-guard.js"></script>
  <script src="scripts/firebase-despesas-reader.js"></script>

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- ======================================================
       ESTILO FLORESTA ÚMIDA (SEM ALTERAÇÕES)
       ====================================================== -->
  <style>
  /* ============================================
     DASHBOARD FLORESTA ÚMIDA - VERSÃO FINAL AJUSTADA
     Relevo Consultoria Ambiental - 2025
     ============================================ */

  body {
    background: linear-gradient(135deg, rgba(25,45,30,0.92) 0%, rgba(40,70,50,0.97) 100%),
      url("https://raw.githubusercontent.com/RelevoAmbiental/relevo-site/refs/heads/main/assets/icons/Logo_atualizada_semNome.png")
      no-repeat center center fixed;
    background-size: 1000px;
    background-blend-mode: overlay;
    color: var(--texto-escuro);
    font-family: 'Montserrat', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 50px 40px;
    width: 100%;
  }

  .header-dashboard {
    background: linear-gradient(135deg, #26C04C 0%, #2E7D32 100%);
    color: white;
    padding: 25px 40px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    width: 100%;
  }

  .header-dashboard-content {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 20px;
  }

  .header-dashboard-content .logo {
    height: 45px;
    justify-self: start;
  }

  .header-dashboard-content h1 {
    text-align: center;
    font-size: 2rem;
    font-weight: 700;
    color: white;
    margin: 0;
  }

  .header-dashboard-content .nav-buttons {
    justify-self: end;
  }

  .view-btn, .btn {
    background: rgba(255,255,255,0.15);
    color: #f5f5f5;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 10px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    padding: 12px 24px;
    font-weight: 600;
  }

  .view-btn.active, .btn-primary {
    background: linear-gradient(145deg, #26C04C, #2E7D32);
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(38,192,76,0.3);
  }

  .view-btn:hover:not(.active),
  .btn-secondary:hover {
    background: rgba(255,255,255,0.25);
    color: #fff;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 30px;
    margin-bottom: 45px;
  }

  .dashboard-grid,
  .table-section,
  .filters-section {
    max-width: 1300px;
    margin: 0 auto 50px auto;
    width: 100%;
  }

  .dashboard-card,
  .stat-card,
  .filters-section {
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(15px);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    color: #f8fdf8;
    width: 100%;
    padding: 45px 40px;
    margin: 15px 10px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .dashboard-card:hover,
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 28px rgba(0,0,0,0.3);
  }

  h3, .stat-value { color: #eaf8e6; }

  .filters-section {
    display: flex;
    flex-direction: column;
    gap: 30px;
    justify-content: center;
  }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 25px;
  }

  .filter-group label {
    color: #d4f0d5;
    font-weight: 600;
  }

  .filter-group select {
    background: rgba(255,255,255,0.15);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 10px;
    padding: 16px;
    font-family: 'Montserrat', sans-serif;
    width: 100%;
    font-size: 1rem;
  }

  .filter-group select option { color: #222; }

  canvas {
    background: rgba(255,255,255,0.05);
    border-radius: 14px;
    padding: 18px;
    box-shadow: inset 0 0 12px rgba(0,0,0,0.25);
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
    gap: 35px;
    margin: 40px auto;
    justify-content: center;
    align-items: stretch;
    max-width: 1200px;
    width: 100%;
  }

  .table-section {
    background: white;
    color: #222;
    border-radius: 12px;
    box-shadow: 0 4px 25px rgba(0,0,0,0.15);
    overflow: hidden;
  }

  .table-header {
    background: var(--verde-primario);
    color: white;
    padding: 18px 30px;
  }

  th { background: var(--verde-escuro); color: #fff; }
  td { background: #fff; color: #333; border-bottom: 1px solid #eee; }
  tbody tr:hover { background: #f7f7f7; }

  footer {
    background: linear-gradient(135deg, #26C04C 0%, #2E7D32 100%);
    color: white;
    text-align: center;
    padding: 30px 20px;
    font-weight: 500;
    font-size: 0.95rem;
    width: 100%;
    margin-top: 60px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.25);
  }

  @media (max-width: 1024px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .filters-grid { grid-template-columns: 1fr; }
  }

  @media (max-width: 768px) {
    body { background-size: 400px; }
    .header-dashboard-content {
      grid-template-columns: 1fr;
      text-align: center;
      gap: 10px;
    }
    .dashboard-card, .stat-card, .filters-section {
      padding: 25px 20px;
      margin: 10px;
    }
  }
  </style>
</head>

<body>
  <header class="header-dashboard">
    <div class="header-dashboard-content">
      <img src="https://raw.githubusercontent.com/RelevoAmbiental/relevo-site/refs/heads/main/assets/icons/Logo_atualizada_horizontal.png"
           alt="Relevo Consultoria Ambiental" class="logo">
      <h1>Gestão de Despesas</h1>
      <div class="nav-buttons">
        <a href="gestao.html" class="btn btn-primary">
          <i class="fas fa-arrow-left"></i> Voltar à Gestão
        </a>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Estatísticas -->
    <div class="stats-grid">
      <div class="stat-card"><h3>Total Gasto</h3><div class="stat-value" id="totalGasto">R$ 0,00</div></div>
      <div class="stat-card"><h3>Despesas Este Mês</h3><div class="stat-value" id="despesasMes">0</div></div>
      <div class="stat-card"><h3>Ticket Médio</h3><div class="stat-value" id="ticketMedio">R$ 0,00</div></div>
      <div class="stat-card"><h3>Taxa de Aprovação</h3><div class="stat-value" id="eficiencia">0%</div></div>
    </div>

    <!-- Filtros -->
    <section class="filters-section">
      <h3>Filtros</h3>
      <div class="filters-grid">
        <div class="filter-group">
          <label for="filterProjeto">Projeto</label>
          <select id="filterProjeto"><option value="">Todos</option></select>
        </div>
        <div class="filter-group">
          <label for="filterFuncionario">Funcionário</label>
          <select id="filterFuncionario"><option value="">Todos</option></select>
        </div>
        <div class="filter-group">
          <label for="filterTipo">Tipo de Despesa</label>
          <select id="filterTipo"><option value="">Todos</option></select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-secondary" onclick="limparFiltros()"><i class="fas fa-times"></i> Limpar</button>
        <button class="btn btn-primary" onclick="aplicarFiltros()"><i class="fas fa-filter"></i> Aplicar</button>
      </div>
    </section>

    <!-- Dashboard -->
    <div class="dashboard-grid">
      <div class="dashboard-card"><h3><i class="fas fa-chart-line"></i> Evolução Mensal</h3><canvas id="chartEvolucao"></canvas></div>
      <div class="dashboard-card"><h3><i class="fas fa-chart-pie"></i> Distribuição por Tipo</h3><canvas id="chartTipos"></canvas></div>
      <div class="dashboard-card"><h3><i class="fas fa-chart-bar"></i> Top Projetos</h3><canvas id="chartProjetos"></canvas></div>
      <div class="dashboard-card"><h3><i class="fas fa-users"></i> Gastos por Funcionário</h3><canvas id="chartFuncionarios"></canvas></div>
    </div>

    <!-- Lista -->
    <section class="table-section">
      <div class="table-header">
        <h3>Lista de Despesas</h3>
        <button class="btn btn-primary" onclick="exportarExcel()" id="exportBtn">
          <i class="fas fa-file-excel"></i> Exportar Excel
        </button>
      </div>
      <div class="table-container">
        <table id="tabelaDespesas">
          <thead><tr><th>Data</th><th>Projeto</th><th>Funcionário</th><th>Tipo</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody id="tbodyDespesas">
            <tr><td colspan="7" class="loading"><div class="loading-spinner"></div><p>Carregando despesas...</p></td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <footer>© 2025 Relevo Consultoria Ambiental — Todos os direitos reservados.</footer>

  <!-- ===================================================== -->
  <script>
    Chart.register(ChartDataLabels);
    Chart.defaults.color = "#000";
    Chart.defaults.font.family = "Montserrat";
    Chart.defaults.plugins.datalabels = {
      color: "#000",
      font: { weight: "600" },
      anchor: "end",
      align: "top",
      formatter: (v) => "R$ " + v.toLocaleString("pt-BR"),
    };

    let despesas = [];
    let filteredDespesas = [];
    let charts = {};

    document.addEventListener('DOMContentLoaded', async () => {
      await carregarDespesas();
    });

    async function carregarDespesas() {
      const snapshot = await dbDespesas.collection('despesas').orderBy('createdAt','desc').get();
      despesas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      atualizarDashboard();
    }

    function atualizarDashboard() {
      atualizarEstatisticas();
      atualizarTabela();
      atualizarGraficos();
    }

    function atualizarEstatisticas() {
      const dados = filteredDespesas.length ? filteredDespesas : despesas;
      const total = dados.reduce((s,d)=>s+(d.valor||0),0);
      const media = dados.length?total/dados.length:0;
      document.getElementById("totalGasto").textContent = formatarMoeda(total);
      document.getElementById("ticketMedio").textContent = formatarMoeda(media);
    }

    function atualizarTabela() {
      const tbody = document.getElementById('tbodyDespesas');
      const dados = filteredDespesas.length ? filteredDespesas : despesas;
      tbody.innerHTML = dados.map(d=>`
        <tr>
          <td>${formatarData(d.data)}</td>
          <td>${d.projeto||'-'}</td>
          <td>${d.funcionario||'-'}</td>
          <td>${d.tipo||'-'}</td>
          <td><strong>${formatarMoeda(d.valor)}</strong></td>
          <td>${d.status||'pendente'}</td>
          <td>
            <button class="btn btn-primary" onclick="aprovarDespesa('${d.id}')"><i class="fas fa-check"></i></button>
            <button class="btn btn-secondary" onclick="editarDespesa('${d.id}')"><i class="fas fa-edit"></i></button>
            <button class="btn btn-secondary" onclick="excluirDespesa('${d.id}')"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`).join('');
    }

    async function aprovarDespesa(id){
      await dbDespesas.collection('despesas').doc(id).update({status:'pago'});
      alert('Despesa aprovada!');
      carregarDespesas();
    }
    async function excluirDespesa(id){
      if(confirm('Deseja excluir esta despesa?')){
        await dbDespesas.collection('despesas').doc(id).delete();
        carregarDespesas();
      }
    }
    async function editarDespesa(id){
      const novoValor = prompt('Novo valor da despesa:');
      if(novoValor){
        await dbDespesas.collection('despesas').doc(id).update({valor:parseFloat(novoValor)});
        carregarDespesas();
      }
    }

    function atualizarGraficos() {
      atualizarGraficoEvolucao();
      atualizarGraficoTipos();
      atualizarGraficoProjetos();
      atualizarGraficoFuncionarios();
    }

    function atualizarGraficoEvolucao() {
      const ctx=document.getElementById("chartEvolucao").getContext("2d");
      const meses=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      const dataMensal=meses.map(()=>0);
      despesas.forEach(d=>{const dt=new Date(d.data);dataMensal[dt.getMonth()]+=(d.valor||0)});
      if(charts.evolucao) charts.evolucao.destroy();
      charts.evolucao=new Chart(ctx,{type:'line',data:{labels:meses,datasets:[{label:'Gastos Mensais',data:dataMensal,borderColor:'#2E7D32',backgroundColor:'rgba(38,192,76,0.2)',fill:true,tension:0.4}]},options:{plugins:{datalabels:{display:true}},responsive:true}});
    }

    function atualizarGraficoTipos(){
      const tipos={}; despesas.forEach(d=>{if(d.tipo) tipos[d.tipo]=(tipos[d.tipo]||0)+d.valor});
      const ctx=document.getElementById('chartTipos').getContext('2d');
      if(charts.tipos) charts.tipos.destroy();
      charts.tipos=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(tipos),datasets:[{data:Object.values(tipos),backgroundColor:['#26C04C','#EB8807','#2E7D32','#396B45','#6B5539']}]},options:{plugins:{datalabels:{display:true}},responsive:true}});
    }

    function atualizarGraficoProjetos(){
      const proj={}; despesas.forEach(d=>{if(d.projeto) proj[d.projeto]=(proj[d.projeto]||0)+d.valor});
      const top=Object.entries(proj).sort(([,a],[,b])=>b-a).slice(0,6);
      const ctx=document.getElementById('chartProjetos').getContext('2d');
      if(charts.projetos) charts.projetos.destroy();
      charts.projetos=new Chart(ctx,{type:'bar',data:{labels:top.map(t=>t[0]),datasets:[{data:top.map(t=>t[1]),backgroundColor:'#26C04C'}]},options:{plugins:{datalabels:{display:true}},responsive:true}});
    }

    function atualizarGraficoFuncionarios(){
      const func={}; despesas.forEach(d=>{if(d.funcionario) func[d.funcionario]=(func[d.funcionario]||0)+d.valor});
      const top=Object.entries(func).sort(([,a],[,b])=>b-a).slice(0,6);
      const ctx=document.getElementById('chartFuncionarios').getContext('2d');
      if(charts.funcionarios) charts.funcionarios.destroy();
      charts.funcionarios=new Chart(ctx,{type:'polarArea',data:{labels:top.map(t=>t[0]),datasets:[{data:top.map(t=>t[1]),backgroundColor:['#26C04C','#EB8807','#2E7D32','#396B45','#6B5539']}]},options:{plugins:{datalabels:{display:true}},responsive:true}});
    }

    function formatarData(d){return d?new Date(d).toLocaleDateString('pt-BR'):'-';}
    function formatarMoeda(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);}
  </script>
</body>
</html>

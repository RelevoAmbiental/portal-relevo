// Configura√ß√£o do Firebase - PROJETO DESPESAS
const firebaseConfig = {
    apiKey: "AIzaSyCDIrPqQs7S_E2UeDGPNeFCVYcv09JFoTs",
    authDomain: "app-despesas-7029f.firebasestorage.app",
    projectId: "app-despesas-7029f",
    storageBucket: "app-despesas-7029f.firebasestorage.app",
    messagingSenderId: "843931176271",
    appId: "1:843931176271:web:5cdafdd10bc28c3bd8893a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Vari√°veis globais
let despesas = [];
let filteredDespesas = [];
let charts = {};

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard inicializado');
    carregarDespesas();
    inicializarFiltros();
});

// Inicializar filtros
function inicializarFiltros() {
    console.log('üéõÔ∏è Filtros inicializados');
}

// Carregar despesas
async function carregarDespesas() {
    try {
        console.log('üìä Carregando despesas...');
        
        const snapshot = await db.collection('despesas')
            .orderBy('createdAt', 'desc')
            .get();
        
        despesas = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            despesas.push({
                id: doc.id,
                ...data,
                data: data.data || '',
                valor: data.valor || 0
            });
        });

        console.log(`‚úÖ ${despesas.length} despesas carregadas`);
        atualizarDashboard();
        atualizarFiltros();

    } catch (error) {
        console.error('‚ùå Erro ao carregar despesas:', error);
        mostrarErro('Erro ao carregar despesas: ' + error.message);
    }
}

// Atualizar dashboard
function atualizarDashboard() {
    atualizarEstatisticas();
    atualizarTabela();
    atualizarGraficos();
}

// Atualizar estat√≠sticas
function atualizarEstatisticas() {
    const dados = filteredDespesas.length > 0 ? filteredDespesas : despesas;
    const total = dados.reduce((sum, d) => sum + (d.valor || 0), 0);
    const ticketMedio = dados.length > 0 ? total / dados.length : 0;
    const despesasPagas = dados.filter(d => d.status === 'pago').length;
    const eficiencia = dados.length > 0 ? (despesasPagas / dados.length) * 100 : 0;

    // Atualizar m√™s atual
    const mesAtual = new Date().getMonth();
    const despesasMes = dados.filter(d => {
        const dataDespesa = new Date(d.data);
        return dataDespesa.getMonth() === mesAtual;
    }).length;

    document.getElementById('totalGasto').textContent = formatarMoeda(total);
    document.getElementById('despesasMes').textContent = despesasMes;
    document.getElementById('ticketMedio').textContent = formatarMoeda(ticketMedio);
    document.getElementById('eficiencia').textContent = eficiencia.toFixed(1) + '%';
}

// Atualizar tabela
function atualizarTabela() {
    const tbody = document.getElementById('tbodyDespesas');
    const dados = filteredDespesas.length > 0 ? filteredDespesas : despesas;
    
    if (dados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">Nenhuma despesa encontrada</td></tr>';
        return;
    }

    tbody.innerHTML = dados.map(despesa => `
        <tr>
            <td>${formatarData(despesa.data)}</td>
            <td>${despesa.projeto || '-'}</td>
            <td>${despesa.funcionario || '-'}</td>
            <td>${despesa.tipo || '-'}</td>
            <td><strong>${formatarMoeda(despesa.valor)}</strong></td>
            <td>
                <span class="status-badge status-${despesa.status || 'pendente'}">
                    ${despesa.status || 'pendente'}
                </span>
            </td>
            <td>
                <div class="action-buttons">
                    <button class="edit-btn" onclick="editarDespesa('${despesa.id}')" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn" onclick="excluirDespesa('${despesa.id}')" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Atualizar gr√°ficos
function atualizarGraficos() {
    const dados = filteredDespesas.length > 0 ? filteredDespesas : despesas;
    
    atualizarGraficoEvolucao(dados);
    atualizarGraficoTipos(dados);
    atualizarGraficoProjetos(dados);
    atualizarGraficoFuncionarios(dados);
}

// Gr√°fico de Evolu√ß√£o
function atualizarGraficoEvolucao(dados) {
    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const currentYear = new Date().getFullYear();
    
    const dadosMensais = {};
    meses.forEach((mes, index) => {
        dadosMensais[mes] = 0;
    });

    dados.forEach(despesa => {
        const data = new Date(despesa.data);
        if (data.getFullYear() === currentYear) {
            const mes = meses[data.getMonth()];
            dadosMensais[mes] += despesa.valor || 0;
        }
    });

    const ctx = document.getElementById('chartEvolucao').getContext('2d');
    if (charts.evolucao) charts.evolucao.destroy();

    charts.evolucao = new Chart(ctx, {
        type: 'line',
        data: {
            labels: meses,
            datasets: [{
                label: 'Gastos Mensais (R$)',
                data: Object.values(dadosMensais),
                borderColor: '#26C04C',
                backgroundColor: 'rgba(38, 192, 76, 0.1)',
                tension: 0.4,
                fill: true
            }]
        }
    });
}

// Gr√°fico de Tipos
function atualizarGraficoTipos(dados) {
    const tiposData = {};
    dados.forEach(d => {
        if (d.tipo) {
            tiposData[d.tipo] = (tiposData[d.tipo] || 0) + (d.valor || 0);
        }
    });

    const ctx = document.getElementById('chartTipos').getContext('2d');
    if (charts.tipos) charts.tipos.destroy();

    charts.tipos = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(tiposData),
            datasets: [{
                data: Object.values(tiposData),
                backgroundColor: ['#26C04C', '#EB8807', '#2E7D32', '#396B45', '#2D4132']
            }]
        }
    });
}

// Gr√°fico de Projetos
function atualizarGraficoProjetos(dados) {
    const projetosData = {};
    dados.forEach(d => {
        if (d.projeto) {
            projetosData[d.projeto] = (projetosData[d.projeto] || 0) + (d.valor || 0);
        }
    });

    const projetosOrdenados = Object.entries(projetosData)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 6);

    const ctx = document.getElementById('chartProjetos').getContext('2d');
    if (charts.projetos) charts.projetos.destroy();

    charts.projetos = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: projetosOrdenados.map(([projeto]) => projeto),
            datasets: [{
                label: 'Valor (R$)',
                data: projetosOrdenados.map(([,valor]) => valor),
                backgroundColor: '#26C04C'
            }]
        }
    });
}

// Gr√°fico de Funcion√°rios
function atualizarGraficoFuncionarios(dados) {
    const funcionariosData = {};
    dados.forEach(d => {
        if (d.funcionario) {
            funcionariosData[d.funcionario] = (funcionariosData[d.funcionario] || 0) + (d.valor || 0);
        }
    });

    const funcionariosOrdenados = Object.entries(funcionariosData)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 6);

    const ctx = document.getElementById('chartFuncionarios').getContext('2d');
    if (charts.funcionarios) charts.funcionarios.destroy();

    charts.funcionarios = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: funcionariosOrdenados.map(([funcionario]) => funcionario),
            datasets: [{
                data: funcionariosOrdenados.map(([,valor]) => valor),
                backgroundColor: ['#26C04C', '#EB8807', '#2E7D32', '#396B45', '#2D4132', '#6B5539']
            }]
        }
    });
}

// Atualizar filtros
function atualizarFiltros() {
    const projetos = [...new Set(despesas.map(d => d.projeto).filter(Boolean))];
    const funcionarios = [...new Set(despesas.map(d => d.funcionario).filter(Boolean))];
    const tipos = [...new Set(despesas.map(d => d.tipo).filter(Boolean))];

    const selectProjeto = document.getElementById('filterProjeto');
    const selectFuncionario = document.getElementById('filterFuncionario');
    const selectTipo = document.getElementById('filterTipo');

    selectProjeto.innerHTML = '<option value="">Todos os projetos</option>';
    projetos.forEach(projeto => {
        selectProjeto.innerHTML += `<option value="${projeto}">${projeto}</option>`;
    });

    selectFuncionario.innerHTML = '<option value="">Todos os funcion√°rios</option>';
    funcionarios.forEach(funcionario => {
        selectFuncionario.innerHTML += `<option value="${funcionario}">${funcionario}</option>`;
    });

    selectTipo.innerHTML = '<option value="">Todos os tipos</option>';
    tipos.forEach(tipo => {
        selectTipo.innerHTML += `<option value="${tipo}">${tipo}</option>`;
    });
}

// Aplicar filtros
function aplicarFiltros() {
    const projeto = document.getElementById('filterProjeto').value;
    const funcionario = document.getElementById('filterFuncionario').value;
    const tipo = document.getElementById('filterTipo').value;

    filteredDespesas = despesas.filter(despesa => {
        if (projeto && despesa.projeto !== projeto) return false;
        if (funcionario && despesa.funcionario !== funcionario) return false;
        if (tipo && despesa.tipo !== tipo) return false;
        return true;
    });

    atualizarDashboard();
}

// Limpar filtros
function limparFiltros() {
    document.getElementById('filterProjeto').value = '';
    document.getElementById('filterFuncionario').value = '';
    document.getElementById('filterTipo').value = '';
    filteredDespesas = [];
    atualizarDashboard();
}

// Alternar views
function showView(view) {
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    document.getElementById('dashboardView').style.display = view === 'dashboard' ? 'block' : 'none';
    document.getElementById('listaView').classList.toggle('active', view === 'lista');
}

// Fun√ß√µes auxiliares
function formatarData(dataString) {
    if (!dataString) return '-';
    const data = new Date(dataString);
    return data.toLocaleDateString('pt-BR');
}

function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(valor || 0);
}

function mostrarErro(mensagem) {
    alert('Erro: ' + mensagem);
}

// Fun√ß√µes futuras (placeholder)
function editarDespesa(id) {
    alert('Editar despesa ' + id + ' - Funcionalidade em desenvolvimento');
}

function excluirDespesa(id) {
    if (confirm('Tem certeza que deseja excluir esta despesa?')) {
        alert('Excluir despesa ' + id + ' - Funcionalidade em desenvolvimento');
    }
}

function exportarExcel() {
    alert('Exportar para Excel - Funcionalidade em desenvolvimento');
}

function logout() {
    window.location.href = 'gestao.html';
}

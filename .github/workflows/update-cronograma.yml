name: Atualizar Cronograma no Portal

on:
  repository_dispatch:
    types: [cronograma-atualizado]
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  update-cronograma:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¬ Checkout do portal-relevo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.RELEVO_GH_PAT }}

      - name: ğŸ§¬ Checkout do cronogramas-relevo
        uses: actions/checkout@v4
        with:
          repository: RelevoAmbiental/cronogramas-relevo
          token: ${{ secrets.RELEVO_GH_PAT }}
          path: cronogramas-src

      - name: ğŸ”§ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            cronogramas-src/package.json
            cronogramas-src/package-lock.json

      - name: ğŸ“¦ Instalar dependÃªncias do cronograma
        working-directory: cronogramas-src
        run: npm ci

      - name: ğŸ—ï¸ Build do cronograma (Vite)
        working-directory: cronogramas-src
        run: npm run build

      - name: ğŸ§¹ Limpar assets antigos
        run: |
          rm -rf cronograma/assets
          mkdir -p cronograma/assets

      - name: ğŸ“ Copiar novos assets
        run: |
          cp -R cronogramas-src/dist/assets/* cronograma/assets/

      - name: ğŸ”„ Padronizar nomes (index.js / index.css)
        run: |
          # JS
          JSFILE=$(ls cronograma/assets/*.js | head -n 1)
          mv "$JSFILE" cronograma/assets/index.js
          # CSS
          CSSFILE=$(ls cronograma/assets/*.css | head -n 1)
          mv "$CSSFILE" cronograma/assets/index.css

      - name: ğŸ’¾ Commit e Push das alteraÃ§Ãµes
        run: |
          git config --local user.email "bot@relevo.eco.br"
          git config --local user.name "RelevoBot"

          git add cronograma/assets/

          if git diff --cached --quiet; then
            echo "Nenhuma alteraÃ§Ã£o para commitar."
            exit 0
          fi

          git commit -m "AtualizaÃ§Ã£o automÃ¡tica do Cronograma (assets atualizados)"
          git push

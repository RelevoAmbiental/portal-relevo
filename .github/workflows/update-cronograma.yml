name: Atualizar Cronograma no Portal

on:
  # ðŸ”¥ Dispara automaticamente quando o cronogramas-relevo mandar o sinal
  repository_dispatch:
    types: [atualizar-cronograma]

  # ðŸ”§ Pode ser rodado manualmente se necessÃ¡rio
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-cronograma:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1) Clonar o repositÃ³rio do portal
      # ---------------------------------------------------------
      - name: Checkout Portal
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2) Baixar o build do repositÃ³rio cronogramas-relevo
      # ---------------------------------------------------------
      - name: Baixar build do Cronograma
        run: |
          echo "ðŸ“¥ Baixando build do repositÃ³rio cronogramas-relevo..."
          rm -rf cronograma
          mkdir cronograma

          git clone --depth=1 https://github.com/RelevoAmbiental/cronogramas-relevo temp

          if [ ! -d "temp/dist" ]; then
            echo "âŒ ERRO: pasta dist nÃ£o existe no cronogramas-relevo!"
            exit 1
          fi

          cp -r temp/dist/* cronograma/
          rm -rf temp

      # ---------------------------------------------------------
      # 3) Gerar index.html com Guard + SessÃ£o
      # ---------------------------------------------------------
      - name: Gerar index.html final
        run: |
          echo "ðŸ“ Gerando index.html personalizado..."
          cat > cronograma/index.html <<EOF
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cronogramas | Relevo Consultoria Ambiental</title>

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <!-- Guard + SessÃ£o -->
    <script src="/scripts/firebase-init-guard.js"></script>
    <script src="/scripts/expose-session.js"></script>

    <!-- Build React (Vite) -->
    <script type="module" crossorigin src="/cronograma/assets/index.js"></script>
    <link rel="stylesheet" crossorigin href="/cronograma/assets/index.css" />
  </head>

  <body>
    <div id="root"></div>
  </body>
</html>
EOF

      # ---------------------------------------------------------
      # 4) Commit e Push para o portal
      # ---------------------------------------------------------
      - name: Commit e push no Portal
        run: |
          echo "ðŸ’¾ Commitando alteraÃ§Ãµes..."
          git config --local user.email "bot@relevo.eco.br"
          git config --local user.name "RelevoBot"

          git add cronograma/
          git commit -m "ðŸš€ AtualizaÃ§Ã£o automÃ¡tica do Cronograma" || echo "Nenhuma mudanÃ§a"

          git push
